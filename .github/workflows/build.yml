name: æž„å»ºæµè§ˆå™¨æ‰©å±•

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: èŽ·å–æž„å»ºä¿¡æ¯
      id: build-info
      run: |
        # èŽ·å–æäº¤ä¿¡æ¯
        COMMIT_SHA_SHORT=$(git rev-parse --short HEAD)
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        
        # ç”Ÿæˆç‰ˆæœ¬å·ï¼ˆåŸºäºŽæ—¶é—´æˆ³ï¼‰
        BUILD_TIME=$(date +%Y%m%d%H%M%S)
        BUILD_VERSION="nightly-${BUILD_TIME}-${COMMIT_SHA_SHORT}"
        
        echo "COMMIT_SHA=${COMMIT_SHA_SHORT}" >> $GITHUB_OUTPUT
        echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_OUTPUT
        echo "BUILD_VERSION=${BUILD_VERSION}" >> $GITHUB_OUTPUT
        
        # æ›´æ–°manifest.jsonä¸­çš„ç‰ˆæœ¬å·
        sed -i "s/\"version\": *\"[^\"]*\"/\"version\": \"${BUILD_VERSION}\"/" manifest.json
        echo "æž„å»ºç‰ˆæœ¬å·: ${BUILD_VERSION}"
    
    - name: éªŒè¯æ‰©å±•æ–‡ä»¶
      run: |
        echo "éªŒè¯æ‰©å±•æ–‡ä»¶ç»“æž„..."
        
        # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
        REQUIRED_FILES=("manifest.json" "content.js" "icon.png")
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ é”™è¯¯: ç¼ºå°‘å¿…éœ€æ–‡ä»¶: $file"
            exit 1
          fi
          echo "âœ… æ–‡ä»¶å­˜åœ¨: $file"
        done
        
        # éªŒè¯manifest.jsonæ ¼å¼
        if ! jq . manifest.json > /dev/null 2>&1; then
          echo "âŒ é”™è¯¯: manifest.jsonæ ¼å¼é”™è¯¯"
          exit 1
        fi
        
        echo "âœ… æ‰€æœ‰æ–‡ä»¶éªŒè¯é€šè¿‡"
    
    - name: åˆ›å»ºæž„å»ºç›®å½•
      run: |
        echo "åˆ›å»ºæž„å»ºç›®å½•..."
        BUILD_DIR="ybt-copy-helper-${{ steps.build-info.outputs.BUILD_VERSION }}"
        mkdir -p "dist/$BUILD_DIR"
        
        # å¤åˆ¶å¿…éœ€æ–‡ä»¶
        cp manifest.json "dist/$BUILD_DIR/"
        cp content.js "dist/$BUILD_DIR/"
        cp icon.png "dist/$BUILD_DIR/"
        cp README.md "dist/$BUILD_DIR/" 2>/dev/null || true
        cp LICENSE "dist/$BUILD_DIR/" 2>/dev/null || true
        
        # å¦‚æžœæœ‰å…¶ä»–æ–‡ä»¶
        if [ -d "assets" ]; then
          cp -r assets "dist/$BUILD_DIR/"
        fi
    
    - name: åˆ›å»ºZIPåŒ…
      run: |
        cd dist
        ZIP_NAME="ybt-copy-helper-${{ steps.build-info.outputs.BUILD_VERSION }}.zip"
        
        echo "åˆ›å»ºZIPåŒ…: $ZIP_NAME"
        zip -r "$ZIP_NAME" "ybt-copy-helper-${{ steps.build-info.outputs.BUILD_VERSION }}"
        
        # è®°å½•æ–‡ä»¶å¤§å°
        FILE_SIZE=$(stat -c%s "$ZIP_NAME")
        echo "ZIPæ–‡ä»¶å¤§å°: $((FILE_SIZE / 1024))KB"
        
        echo "ZIP_PATH=$(pwd)/$ZIP_NAME" >> $GITHUB_ENV
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
    
    - name: åˆ›å»ºCRXåŒ…ï¼ˆå¯é€‰ï¼‰
      run: |
        echo "æ³¨æ„ï¼šCRXåŒ…éœ€è¦ç­¾åå¯†é’¥"
        echo "å¦‚éœ€åˆ›å»ºCRXåŒ…ï¼Œè¯·å‚è€ƒä»¥ä¸‹æ­¥éª¤ï¼š"
        echo "1. ç”Ÿæˆç§æœ‰å¯†é’¥ï¼šopenssl genrsa -out key.pem 2048"
        echo "2. å°†å¯†é’¥æ·»åŠ åˆ°GitHub Secrets"
        echo "3. ä½¿ç”¨crx3-packå·¥å…·æ‰“åŒ…"
        echo ""
        echo "æ‚¨å¯ä»¥é€šè¿‡åŠ è½½å·²è§£åŽ‹çš„æ‰©å±•ç¨‹åºæ¥ä½¿ç”¨ZIPæ–‡ä»¶"
    
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ybt-copy-helper-build
        path: |
          dist/*.zip
          dist/ybt-copy-helper-*
        retention-days: 30
    
    - name: ç”Ÿæˆæž„å»ºä¿¡æ¯æ–‡ä»¶
      run: |
        echo "ç”Ÿæˆæž„å»ºä¿¡æ¯..."
        BUILD_INFO_FILE="dist/build-info.json"
        
        cat > "$BUILD_INFO_FILE" << EOF
        {
          "version": "${{ steps.build-info.outputs.BUILD_VERSION }}",
          "commit_sha": "${{ steps.build-info.outputs.COMMIT_SHA }}",
          "branch": "${{ steps.build-info.outputs.BRANCH_NAME }}",
          "build_time": "$(date -Iseconds)",
          "downloads": {
            "zip": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "source": "https://github.com/${{ github.repository }}/tree/${{ steps.build-info.outputs.COMMIT_SHA }}"
          }
        }
        EOF
        
        echo "æž„å»ºä¿¡æ¯ï¼š"
        cat "$BUILD_INFO_FILE"
    
    - name: ä¸Šä¼ æž„å»ºä¿¡æ¯
      uses: actions/upload-artifact@v4
      with:
        name: build-info
        path: dist/build-info.json
        retention-days: 30
    
    - name: å‘å¸ƒåˆ°å·¥ä½œæµæ€»ç»“
      run: |
        echo "## ðŸš€ æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ç‰ˆæœ¬**: ${{ steps.build-info.outputs.BUILD_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "**æäº¤**: ${{ steps.build-info.outputs.COMMIT_SHA }}" >> $GITHUB_STEP_SUMMARY
        echo "**åˆ†æ”¯**: ${{ steps.build-info.outputs.BRANCH_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ ä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. å‰å¾€æœ¬å·¥ä½œæµçš„ **Artifacts** éƒ¨åˆ†ä¸‹è½½æž„å»ºæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "2. ä¸‹è½½åŽè§£åŽ‹ZIPæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "3. åœ¨æµè§ˆå™¨ä¸­åŠ è½½å·²è§£åŽ‹çš„æ‰©å±•ç¨‹åº" >> $GITHUB_STEP_SUMMARY